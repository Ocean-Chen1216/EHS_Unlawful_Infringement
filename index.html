<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>è·å ´ä¸æ³•ä¾µå®³é é˜²ä¹‹å±å®³è¾¨è­˜åŠé¢¨éšªè©•ä¼°è¡¨ v7.1 (å ±å‘Šæ¨£å¼çµ±ä¸€ç‰ˆ)</title>
<link rel="icon" href="icon-192.png" type="image/png">
<link rel="manifest" href="manifest.json">
<style>
  body { font-family: -apple-system, "Microsoft JhengHei", sans-serif; background: #f0f2f5; margin: 0; padding: 0; color: #333; }
  
  /* å¢åŠ åº•éƒ¨é‚Šè·ï¼Œç¢ºä¿å…§å®¹ä¸æœƒè¢«æ‡¸æµ®æŒ‰éˆ•æ“‹ä½ */
  .container { 
      background: white; 
      padding: 15px; 
      margin: 15px auto 100px auto; /* åº•éƒ¨ç•™ç™½ 100px */
      max-width: 800px;
      border-radius: 10px; 
      box-shadow: 0 2px 10px rgba(0,0,0,0.05); 
  }
  
  .version-tag { text-align: right; font-size: 0.8rem; color: #888; margin-bottom: 5px; }
  .section { margin-bottom: 20px; border: 1px solid #eee; padding: 15px; border-radius: 8px; background: #fff; }
  .section h3 { margin-top: 0; border-bottom: 2px solid #eee; padding-bottom: 10px; font-size: 1.1rem; color: #0288d1; display: flex; justify-content: space-between; align-items: center;}
  label { display: block; margin-bottom: 5px; font-weight: bold; color: #555; font-size: 0.95rem; }
  select, input[type="text"], input[type="date"], textarea { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 6px; font-size: 16px; margin-bottom: 10px; box-sizing: border-box; background: #fff; }
  textarea { height: 60px; resize: vertical; }
  
  .risk-row { padding: 20px 0; border-bottom: 5px solid #f0f2f5; }
  .risk-id { background: #333; color: #fff; padding: 2px 6px; border-radius: 4px; font-size: 0.8rem; margin-right: 5px; }
  .mk-note { display: inline-block; font-size: 0.8rem; color: #0288d1; background: #e1f5fe; padding: 2px 6px; border-radius: 4px; margin-top: 5px; }
  
  .toggle-area { display: flex; gap: 10px; margin-bottom: 15px; align-items: center; background: #fafafa; padding: 10px; border-radius: 6px; }
  .btn-toggle { flex: 1; padding: 10px; border: 1px solid #ddd; border-radius: 6px; cursor: pointer; text-align: center; font-weight: bold; background: white; }
  .btn-toggle.active-yes { background: #e74c3c; color: white; border-color: #c0392b; }
  .btn-toggle.active-no { background: #2ecc71; color: white; border-color: #27ae60; }
  
  .detail-area { display: none; padding-left: 10px; border-left: 3px solid #e74c3c; }
  .detail-area.show { display: block; animation: slideDown 0.3s; }
  
  .violence-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px; margin-bottom: 15px; background: #fff5f5; padding: 10px; border-radius: 6px; }
  .v-option { display: flex; align-items: center; font-size: 0.9rem; cursor: pointer; }
  .v-option input { width: auto; margin-right: 8px; margin-bottom: 0; }
  .v-option.pre-checked { color: #d35400; font-weight: bold; }
  
  .eval-box { display: flex; gap: 10px; align-items: center; margin-bottom: 15px; }
  .eval-select { flex: 1; }
  .risk-result { width: 80px; text-align: center; font-weight: bold; padding: 10px; border-radius: 6px; font-size: 0.9rem; background: #eee; }
  
  .control-box { margin-top: 10px; padding-top: 10px; border-top: 1px dashed #ddd; }
  .chip-container { display: flex; flex-wrap: wrap; gap: 5px; margin-bottom: 8px; }
  .chip { font-size: 0.8rem; background: #eee; padding: 5px 10px; border-radius: 15px; cursor: pointer; border: 1px solid #ddd; }
  .new-control-area { display: none; background: #fff5f5; padding: 10px; border-radius: 6px; border: 1px solid #feb2b2; margin-top: 10px; }
  .new-control-area.show { display: block; }
  .error-border { border: 2px solid red !important; background-color: #fff0f0; }
  
  .risk-low { color: #27ae60; background: #e8f8f5; }
  .risk-mid { color: #e67e22; background: #fdebd0; }
  .risk-high { color: #c0392b; background: #fadbd8; }
  
  .btn-info { font-size: 0.8rem; background: #e1f5fe; color: #0288d1; border: none; padding: 5px 10px; border-radius: 15px; cursor: pointer; }
  .modal { display: none; position: fixed; z-index: 99; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); }
  .modal-content { background-color: #fefefe; margin: 15% auto; padding: 20px; border: 1px solid #888; width: 85%; max-width: 500px; border-radius: 8px; }
  .close { float: right; font-size: 28px; font-weight: bold; cursor: pointer; }

  /* FAB æŒ‰éˆ• */
  .fab-container { position: fixed; bottom: 25px; right: 25px; display: flex; flex-direction: column; gap: 12px; z-index: 1000; }
  .btn-float { display: flex; align-items: center; justify-content: center; padding: 12px 20px; border-radius: 50px; color: white; font-weight: bold; box-shadow: 0 4px 12px rgba(0,0,0,0.3); cursor: pointer; border: none; font-size: 1rem; transition: transform 0.2s, box-shadow 0.2s; min-width: 140px; }
  .btn-float:active { transform: scale(0.96); box-shadow: 0 2px 6px rgba(0,0,0,0.2); }
  .btn-main { background: linear-gradient(135deg, #27ae60, #2ecc71); } 
  .btn-sub { background: linear-gradient(135deg, #2980b9, #3498db); font-size: 0.9rem; }

  @keyframes slideDown { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
  
  @media (max-width: 600px) {
      .fab-container { bottom: 20px; right: 20px; }
      .btn-float { padding: 10px 15px; font-size: 0.9rem; }
  }
</style>
</head>
<body>

<div id="infoModal" class="modal">
  <div class="modal-content">
    <span class="close" onclick="document.getElementById('infoModal').style.display='none'">&times;</span>
    <h3>è©•åˆ†æ¨™æº–èªªæ˜</h3>
    <p><strong>å¯èƒ½æ€§ (P)ï¼š</strong><br>1: 1 - æ¥µå°‘ç™¼ç”Ÿ (æ•¸å¹´ä¸€æ¬¡)<br>2: 2 - å¯èƒ½ç™¼ç”Ÿ (ä¸€å¹´æ•¸æ¬¡)<br>3: 3 - ç¶“å¸¸ç™¼ç”Ÿ (æ¯é€±/æœˆ)</p>
    <p><strong>åš´é‡æ€§ (S)ï¼š</strong><br>1: 1 - è¼•å¾® (å£é ­é¨·æ“¾/ç„¡å—å‚·)<br>2: 2 - ä¸­åº¦ (éœ€é†«ç™‚è«®å•†/è¼•å‚·)<br>3: 3 - åš´é‡ (ä½é™¢/æ°¸ä¹…å¤±èƒ½)</p>
    <hr>
    <p><strong>é¢¨éšªç­‰ç´šï¼š</strong><br>ğŸŸ¢ 1-2åˆ†ï¼šä½åº¦<br>ğŸŸ  3-4åˆ†ï¼šä¸­åº¦<br>ğŸ”´ 6-9åˆ†ï¼šé«˜åº¦</p>
  </div>
</div>

<div class="container">
  <div class="version-tag">v7.1 (å ±å‘Šæ¨£å¼çµ±ä¸€ç‰ˆ)</div>
  <h2 style="text-align:center; color:#2c3e50;">è·å ´ä¸æ³•ä¾µå®³é é˜²ä¹‹å±å®³è¾¨è­˜åŠé¢¨éšªè©•ä¼°è¡¨</h2>
  <div class="section">
    <h3>1. åŸºæœ¬è³‡æ–™</h3>
    <label>å§“å</label><input type="text" id="empName" placeholder="è«‹è¼¸å…¥å§“å">
    <label>éƒ¨é–€</label><select id="empDept"><option value="V1">V1</option>
<option value="V2">V2</option>
<option value="V3">V3</option>
<option value="V5">V5</option>
<option value="V6">V6</option>
<option value="V7">V7</option>
<option value="å·¥å‹™">å·¥å‹™</option>
<option value="è¡ŒéŠ·">è¡ŒéŠ·</option>
<option value="è²¡æœƒ">è²¡æœƒ</option>
<option value="é–‹ç™¼">é–‹ç™¼</option>
<option value="è³‡è¨Š">è³‡è¨Š</option>
<option value="é‹ç±Œ">é‹ç±Œ</option>
<option value="æ–°äº‹æ¥­">æ–°äº‹æ¥­</option>
<option value="ç¸½ç®¡ç†">ç¸½ç®¡ç†</option></select>
    <label>æ—¥æœŸ</label><input type="date" id="evalDate">
  </div>
  <div class="section">
    <h3>2. é¢¨éšªè¾¨è­˜ <button class="btn-info" onclick="document.getElementById('infoModal').style.display='block'">â“ æ¨™æº–</button></h3>
    <div id="riskList"></div>
  </div>
  <div class="section">
    <h3>3. ç°½åç¢ºèª <span style="color:red; font-size:0.8rem;">(å¿…å¡«)</span></h3>
    <canvas id="sigCanvas" style="width:100%; height:150px; border:2px dashed #ccc;"></canvas>
    <button onclick="clearSig()" style="margin-top:5px; background:#ccc; border:none; padding:5px; border-radius:4px;">æ¸…é™¤é‡ç°½</button>
  </div>
</div>

<div class="fab-container">
    <button class="btn-float btn-sub" onclick="sendEmail()">âœ‰ï¸ å¯„çµ¦è² è²¬äºº</button>
    <button class="btn-float btn-main" onclick="generateReport()">ğŸ“¥ ä¸‹è¼‰å ±å‘Š</button>
</div>

<script>
document.getElementById('evalDate').valueAsDate = new Date();
const questions = [
    {
        "id": "E01",
        "q": "æ˜¯å¦æœ‰å¤–éƒ¨ä¹‹äººå“¡(æ‰¿åŒ…å•†ã€å®¢æˆ¶ã€æœå‹™å°è±¡ç­‰)å› å…¶è¡Œç‚ºä¸å¯é çŸ¥ï¼Œå¯èƒ½é€ æˆè·å ´æš´åŠ›",
        "note": "é©ç”¨ï¼šç¸½éƒ¨æ¥å¾…ã€æ¸…æ½”å¤–åŒ…ã€è¨­å‚™ç¶­ä¿®",
        "types": "è·å ´æš´åŠ›ã€æ€§é¨·æ“¾"
    },
    {
        "id": "E02",
        "q": "æ˜¯å¦æœ‰å·²çŸ¥å·¥ä½œæœƒæ¥è§¸æœ‰æš´åŠ›å²ä¹‹å®¢æˆ¶",
        "note": "ä¸€èˆ¬é©ç”¨",
        "types": "è·å ´æš´åŠ›ã€è·Ÿè¹¤é¨·æ“¾"
    },
    {
        "id": "E03",
        "q": "å·¥ä½œæ€§è³ªç‚ºåŸ·è¡Œå…¬å…±å®‰å…¨æ¥­å‹™ (ä¾æ³•ç¶­æŒå…¬å…±ç§©åºï¼Œä¿è­·å…¬å¸å®‰å…¨ï¼Œé˜²æ­¢ä¸€åˆ‡å±å®³ä¹‹æ¥­å‹™)",
        "note": "ä¸€èˆ¬é©ç”¨",
        "types": "è·å ´æš´åŠ›"
    },
    {
        "id": "E04",
        "q": "å·¥ä½œæ˜¯å¦ç‚ºå–®ç¨ä½œæ¥­",
        "note": "é‡é»é©ç”¨ï¼šå¯¦é©—å®¤äººå“¡ã€æ¨£å“å®¤åŠ ç­äººå“¡",
        "types": "è·å ´æš´åŠ›ã€æ€§é¨·æ“¾ã€è·Ÿè¹¤é¨·æ“¾"
    },
    {
        "id": "E05",
        "q": "æ˜¯å¦éœ€æ–¼æ·±å¤œæˆ–å‡Œæ™¨å·¥ä½œ",
        "note": "é‡é»é©ç”¨ï¼šé…åˆå—ç¾/ä¸­äºå·¥å» æ™‚å·®ä¹‹è¦–è¨Šæœƒè­°äººå“¡",
        "types": "è·å ´æš´åŠ›ã€è·å ´éœ¸å‡Œã€æ€§é¨·æ“¾"
    },
    {
        "id": "E06",
        "q": "æ˜¯å¦éœ€æ–¼è¼ƒé™Œç”Ÿä¹‹ç’°å¢ƒå·¥ä½œ",
        "note": "é©ç”¨ï¼šæ¥­å‹™æˆ–éœ€å·¡è¦–æµ·å¤–å·¥å» ä¹‹ä¸»ç®¡",
        "types": "è·å ´æš´åŠ›ã€æ€§é¨·æ“¾ã€è·Ÿè¹¤é¨·æ“¾"
    },
    {
        "id": "E07",
        "q": "å·¥ä½œæ¶‰åŠç¾é‡‘äº¤æ˜“ã€é‹é€æˆ–è™•ç†è²´é‡ç‰©å“",
        "note": "é©ç”¨ï¼šæ¨£å“å®¤(é«˜åƒ¹å¸ƒæ–™/æ¨£è¡£)æˆ–è²¡å‹™éƒ¨",
        "types": "è·å ´æš´åŠ›"
    },
    {
        "id": "E08",
        "q": "å·¥ä½œæ˜¯å¦ç‚ºç›´æ¥é¢å°å…¬çœ¾ä¹‹ç¬¬ä¸€ç·šæœå‹™å·¥ä½œ",
        "note": "é©ç”¨ï¼šç¸½æ©Ÿæ«ƒæª¯(å…¶é¤˜éƒ¨é–€é¢¨éšªè¼ƒä½)",
        "types": "è·å ´æš´åŠ›ã€è·å ´éœ¸å‡Œã€æ€§é¨·æ“¾ã€è·Ÿè¹¤é¨·æ“¾"
    },
    {
        "id": "E09",
        "q": "å·¥ä½œæ˜¯å¦èˆ‡é…—é…’ã€æ¯’ç™®ã€æƒ…ç·’ä¸ç©©ä¹‹äººæ¥è§¸",
        "note": "ä¸€èˆ¬é©ç”¨",
        "types": "è·å ´æš´åŠ›ã€æ€§é¨·æ“¾"
    },
    {
        "id": "E10",
        "q": "å·¥ä½œæ˜¯å¦éœ€æ¥è§¸çµ•æœ›æˆ–ææ‡¼æˆ–äºŸéœ€è¢«é—œæ‡·ç…§é¡§è€…",
        "note": "ä¸€èˆ¬é©ç”¨",
        "types": "è·å ´æš´åŠ›"
    },
    {
        "id": "E11",
        "q": "æ˜¯å¦æœ‰è‡ªè¡Œé€šå ±å› ç§äººé—œä¿‚é­å—ä¸æ³•ä¾µå®³å¨è„…è€…æˆ–ç‚ºå®¶åº­æš´åŠ›å—å®³è€…",
        "note": "é©ç”¨ï¼šå…¨å“¡",
        "types": "è·å ´æš´åŠ›ã€è·Ÿè¹¤é¨·æ“¾"
    },
    {
        "id": "E12",
        "q": "æ–°é€²å‹å·¥æ˜¯å¦æœ‰å°šæœªæ¥å—è·å ´ä¸æ³•ä¾µå®³é é˜²æ•™è‚²è¨“ç·´è€…",
        "note": "é©ç”¨ï¼šäººè³‡æª¢æ ¸é …ç›®",
        "types": "è·å ´æš´åŠ›ã€è·å ´éœ¸å‡Œã€å°±æ¥­æ­§è¦–ã€æ€§é¨·æ“¾ã€è·Ÿè¹¤é¨·æ“¾"
    },
    {
        "id": "E13",
        "q": "å·¥ä½œå ´æ‰€ä½æ–¼äº¤é€šä¸ä¾¿ï¼Œåé åœ°å€è€…",
        "note": "ä¸€èˆ¬é©ç”¨",
        "types": "è·å ´æš´åŠ›ã€æ€§é¨·æ“¾"
    },
    {
        "id": "I01",
        "q": "å·¥ä½œç’°å¢ƒä¸­æ˜¯å¦æœ‰è®“æ–½æš´è€…éš±è—çš„åœ°æ–¹",
        "note": "é©ç”¨ï¼šæ¨£å“å®¤å †ç–Šå€ã€å¯¦é©—å®¤è§’è½ã€åœè»Šå ´",
        "types": "è·å ´æš´åŠ›ã€æ€§é¨·æ“¾ã€è·Ÿè¹¤é¨·æ“¾"
    },
    {
        "id": "I02",
        "q": "é›¢é–‹å·¥ä½œå ´æ‰€å¾Œï¼Œæ˜¯å¦å¯èƒ½é­é‡å› åŸ·è¡Œè·å‹™æ‰€è‡´ä¹‹ä¸æ³•ä¾µå®³è¡Œç‚º",
        "note": "é©ç”¨ï¼šæ¥­å‹™äººå“¡æˆ–è™•ç†å®¢è¨´è€…",
        "types": "è·Ÿè¹¤é¨·æ“¾ã€è·å ´æš´åŠ›"
    },
    {
        "id": "I03",
        "q": "å–®ä½å…§æ˜¯å¦æ›¾ç™¼ç”Ÿä¸»ç®¡æˆ–å“¡å·¥é­å—åŒäº‹(å«ä¸Šå¸)ä¸ç•¶è¨€è¡Œä¹‹å°å¾…",
        "note": "é‡é»é©ç”¨ï¼šå«é ç«¯æœƒè­°è¨€èªæš´åŠ›",
        "types": "è·å ´æš´åŠ›ã€è·å ´éœ¸å‡Œã€æ€§é¨·æ“¾ã€å°±æ¥­æ­§è¦–"
    },
    {
        "id": "I04",
        "q": "æ˜¯å¦æœ‰å› ä¸åŒæ€§åˆ¥ã€å¹´é½¡ã€åœ‹ç±æˆ–å®—æ•™ä¿¡ä»°å—åˆ°è·å ´æš´åŠ›ä¹‹å–®ä½å…§å·¥ä½œè€…",
        "note": "é©ç”¨ï¼šè·¨åœ‹ä¼æ¥­æ–‡åŒ–ã€å¤–æ´¾äººå“¡",
        "types": "å°±æ¥­æ­§è¦–ã€è·å ´éœ¸å‡Œ"
    },
    {
        "id": "I05",
        "q": "æ˜¯å¦æœ‰å–®ä½å…§å·¥ä½œè€…ä¹‹é›¢è·æˆ–è«‹æ±‚èª¿è·åŸå› æºæ–¼è·å ´æš´åŠ›äº‹ä»¶ä¹‹ç™¼ç”Ÿ",
        "note": "ä¸€èˆ¬é©ç”¨",
        "types": "è·å ´æš´åŠ›ã€è·å ´éœ¸å‡Œã€æ€§é¨·æ“¾"
    },
    {
        "id": "I06",
        "q": "å–®ä½å…§æ˜¯å¦æœ‰è¢«åŒäº‹æ’æ“ ä¹‹å·¥ä½œè€…",
        "note": "ä¸€èˆ¬é©ç”¨",
        "types": "è·å ´éœ¸å‡Œã€å°±æ¥­æ­§è¦–"
    },
    {
        "id": "I07",
        "q": "å–®ä½å…§æ˜¯å¦æœ‰é…—é…’ã€æ¯’ç™®ä¹‹å·¥ä½œè€…",
        "note": "ä¸€èˆ¬é©ç”¨",
        "types": "è·å ´æš´åŠ›ã€æ€§é¨·æ“¾"
    },
    {
        "id": "I08",
        "q": "å–®ä½å…§æ˜¯å¦æœ‰æƒ…ç·’ä¸ç©©å®šæˆ–æ˜¯ç²¾ç¥ç–¾æ‚£ç—…å²è€…",
        "note": "ä¸€èˆ¬é©ç”¨",
        "types": "è·å ´æš´åŠ›ã€è·å ´éœ¸å‡Œ"
    },
    {
        "id": "I09",
        "q": "å–®ä½å…§æ˜¯å¦æœ‰è™•æ–¼æƒ…ç·’ä½è½ã€çµ•æœ›æˆ–ææ‡¼ï¼ŒäºŸéœ€è¢«é—œæ‡·ç…§é¡§è€…",
        "note": "ä¸€èˆ¬é©ç”¨",
        "types": "è·å ´æš´åŠ›"
    },
    {
        "id": "I10",
        "q": "å–®ä½å…§æ˜¯å¦æœ‰è¶…æ™‚å·¥ä½œï¼Œåæ‡‰å·¥ä½œå£“åŠ›å¤§è€…",
        "note": "é‡é»é©ç”¨ï¼šè¶•å­£ç¯€æ€§è¨‚å–®ã€è·¨æ™‚å€å·¥ä½œè€…",
        "types": "è·å ´éœ¸å‡Œ"
    },
    {
        "id": "I11",
        "q": "å–®ä½å…§å·¥ä½œç’°å¢ƒæ˜¯å¦æœ‰ç©ºé–“æ“æ“ ã€ç…§æ˜è¨­å‚™ä¸è¶³ä¹‹å•é¡Œ",
        "note": "é©ç”¨ï¼šæ¨£å“å®¤å‹•ç·šã€å€‰åº«å€",
        "types": "è·å ´æš´åŠ›ã€æ€§é¨·æ“¾"
    },
    {
        "id": "I12",
        "q": "å·¥ä½œå ´æ‰€å‡ºå…¥æ˜¯å¦æœªæœ‰ç›¸é—œç®¡åˆ¶æªæ–½",
        "note": "é©ç”¨ï¼šè¾¦å…¬å®¤é–€ç¦ç®¡ç†",
        "types": "è·å ´æš´åŠ›ã€è·Ÿè¹¤é¨·æ“¾"
    }
];
const commonControls = ["é–€ç¦åˆ·å¡ç®¡åˆ¶", "24Hä¿å…¨äººå“¡", "CCTVç›£è¦–ç³»çµ±", "ç·Šæ€¥é€šå ±æŒ‰éˆ•", "å“¡å·¥ç”³è¨´ç®¡é“", "æ•™è‚²è¨“ç·´", "é›™äººä½œæ¥­æ©Ÿåˆ¶", "ç…§æ˜å……è¶³", "ä¸æ³•ä¾µå®³é é˜²å…¬å‘Š"];
const violenceList = ["è·å ´æš´åŠ›", "è·å ´éœ¸å‡Œ", "å°±æ¥­æ­§è¦–", "æ€§é¨·æ“¾", "è·Ÿè¹¤é¨·æ“¾"];
const managerEmail = "oceanchen@makalot.com.tw";
const defs = {
    p: { 1: "1 - æ¥µå°‘ç™¼ç”Ÿ (æ•¸å¹´ä¸€æ¬¡)", 2: "2 - å¯èƒ½ç™¼ç”Ÿ (ä¸€å¹´æ•¸æ¬¡)", 3: "3 - ç¶“å¸¸ç™¼ç”Ÿ (æ¯é€±/æœˆ)" },
    s: { 1: "1 - è¼•å¾® (å£é ­é¨·æ“¾/ç„¡å—å‚·)", 2: "2 - ä¸­åº¦ (éœ€é†«ç™‚è«®å•†/è¼•å‚·)", 3: "3 - åš´é‡ (ä½é™¢/æ°¸ä¹…å¤±èƒ½)" }
};
let hasSigned = false;

const list = document.getElementById('riskList');
questions.forEach((item, idx) => {
    let preSelected = [];
    if(item.types) { preSelected = item.types.split(/[ã€,;]/).map(t => t.trim()); }
    let vHtml = "";
    violenceList.forEach(v => {
        const isChecked = preSelected.includes(v);
        const checkedStr = isChecked ? "checked" : "";
        const clsStr = isChecked ? "v-option pre-checked" : "v-option";
        vHtml += `<label class="${clsStr}"><input type="checkbox" name="v_type_${idx}" value="${v}" ${checkedStr}> ${v}</label>`;
    });
    let chipsHtml = "";
    commonControls.forEach(c => {
        chipsHtml += `<span class="chip" onclick="addControl(${idx}, '${c}')">${c}</span>`;
    });
    const div = document.createElement('div');
    div.className = 'risk-row';
    div.innerHTML = `
        <div class="risk-header">
            <span class="risk-id">${item.id}</span>
            <strong>${item.q}</strong>
            ${item.note ? `<div class="mk-note">${item.note}</div>` : ''}
        </div>
        <label>æ˜¯å¦é©ç”¨ / å­˜åœ¨æ­¤é¢¨éšªï¼Ÿ</label>
        <div class="toggle-area" id="toggle_area_${idx}">
             <div class="btn-toggle" id="btn_yes_${idx}" onclick="toggleApp(${idx}, true)">â–¡ æ˜¯ (å¡«å¯«ç´°é …)</div>
             <div class="btn-toggle active-no" id="btn_no_${idx}" onclick="toggleApp(${idx}, false)">â–  å¦ (ç„¡é¢¨éšª)</div>
        </div>
        <input type="hidden" id="is_app_${idx}" value="false">
        <div id="detail_${idx}" class="detail-area">
            <label style="margin-top:10px;">1. ç¢ºèªæš´åŠ›é¡å‹ (å¯è¤‡é¸)ï¼š</label>
            <div class="violence-grid" id="v_grid_${idx}">${vHtml}</div>
            <div class="eval-box">
                <div class="eval-select">
                    <label style="font-size:0.8rem;margin-bottom:2px;">2. å¯èƒ½æ€§</label>
                    <select id="prob_${idx}" onchange="calc(${idx})" style="margin:0;">
                        <option value="1">${defs.p[1]}</option>
                        <option value="2">${defs.p[2]}</option>
                        <option value="3">${defs.p[3]}</option>
                    </select>
                    <div style="height:10px;"></div>
                    <label style="font-size:0.8rem;margin-bottom:2px;">3. åš´é‡æ€§</label>
                    <select id="sev_${idx}" onchange="calc(${idx})" style="margin:0;">
                        <option value="1">${defs.s[1]}</option>
                        <option value="2">${defs.s[2]}</option>
                        <option value="3">${defs.s[3]}</option>
                    </select>
                </div>
                <div id="res_${idx}" class="risk-result risk-low" data-score="1">1<br>ä½åº¦</div>
            </div>
            <div class="control-box">
                <label>4. ç¾æœ‰æ§åˆ¶æªæ–½ (å¿…å¡«)ï¼š</label>
                <div class="chip-container">${chipsHtml}</div>
                <textarea id="exist_${idx}" placeholder="è«‹æè¿°ç¾æœ‰é˜²è­·..."></textarea>
                <div id="new_box_${idx}" class="new-control-area">
                    <label style="color:#c0392b;">âš ï¸ 5. é¢¨éšªé«˜ï¼Œè«‹å¡«å¯«ã€Œæ–°å¢æ”¹å–„å°ç­–ã€ï¼š</label>
                    <textarea id="new_${idx}" placeholder="ä¾‹å¦‚ï¼šåŠ è£ç›£è¦–å™¨..."></textarea>
                </div>
            </div>
        </div>
    `;
    list.appendChild(div);
});

function toggleApp(idx, isYes) {
    const detail = document.getElementById(`detail_${idx}`);
    const val = document.getElementById(`is_app_${idx}`);
    const btnYes = document.getElementById(`btn_yes_${idx}`);
    const btnNo = document.getElementById(`btn_no_${idx}`);
    if(isYes) {
        detail.classList.add('show'); val.value = "true";
        btnYes.className = "btn-toggle active-yes"; btnYes.innerText = "â–  æ˜¯";
        btnNo.className = "btn-toggle"; btnNo.innerText = "â–¡ å¦";
    } else {
        detail.classList.remove('show'); val.value = "false";
        btnYes.className = "btn-toggle"; btnYes.innerText = "â–¡ æ˜¯";
        btnNo.className = "btn-toggle active-no"; btnNo.innerText = "â–  å¦";
    }
}
function addControl(idx, text) {
    const area = document.getElementById(`exist_${idx}`);
    if(area.value.includes(text)) return;
    area.value += (area.value ? "ã€" : "") + text;
}
function calc(idx) {
    const p = parseInt(document.getElementById(`prob_${idx}`).value);
    const s = parseInt(document.getElementById(`sev_${idx}`).value);
    const score = p * s;
    const resDiv = document.getElementById(`res_${idx}`);
    const newBox = document.getElementById(`new_box_${idx}`);
    let text = `${score}<br>ä½åº¦`, cls = 'risk-low';
    if(score >= 3) {
        newBox.classList.add('show');
        if(score >= 6) { text = `${score}<br>é«˜åº¦`; cls = 'risk-high'; }
        else { text = `${score}<br>ä¸­åº¦`; cls = 'risk-mid'; }
    } else { newBox.classList.remove('show'); }
    resDiv.className = `risk-result ${cls}`;
    resDiv.innerHTML = text;
    resDiv.setAttribute('data-score', score);
}

const canvas = document.getElementById("sigCanvas");
const ctx = canvas.getContext("2d");
function resize() { 
    const ratio = Math.max(window.devicePixelRatio||1, 1);
    canvas.width = canvas.offsetWidth*ratio; canvas.height = canvas.offsetHeight*ratio;
    ctx.scale(ratio,ratio); 
}
window.addEventListener("resize", resize); setTimeout(resize, 500);
let isDrawing = false;
canvas.addEventListener('mousedown', start); canvas.addEventListener('touchstart', start, {passive:false});
canvas.addEventListener('mousemove', draw); canvas.addEventListener('touchmove', draw, {passive:false});
canvas.addEventListener('mouseup', stop); canvas.addEventListener('mouseout', stop); canvas.addEventListener('touchend', stop);
function start(e) { if(e.target==canvas) e.preventDefault(); hasSigned=true; ctx.beginPath(); var p=pos(e); ctx.moveTo(p.x,p.y); isDrawing=true; }
function draw(e) { if(!isDrawing) return; if(e.target==canvas) e.preventDefault(); var p=pos(e); ctx.lineTo(p.x,p.y); ctx.stroke(); }
function stop() { isDrawing = false; }
function pos(e) { var r=canvas.getBoundingClientRect(); var cx=e.touches?e.touches[0].clientX:e.clientX; var cy=e.touches?e.touches[0].clientY:e.clientY; return {x:cx-r.left,y:cy-r.top}; }
function clearSig() { ctx.clearRect(0,0,canvas.width/window.devicePixelRatio,canvas.height/window.devicePixelRatio); hasSigned = false; }

function generateReport() {
    const name = document.getElementById('empName').value;
    if(!name) { alert("è«‹è¼¸å…¥å§“å"); return; }
    document.querySelectorAll('.error-border').forEach(el => el.classList.remove('error-border'));
    let hasError = false;
    
    let highRiskCount = 0;
    let midRiskCount = 0;
    
    questions.forEach((q, i) => {
        const isApp = document.getElementById(`is_app_${i}`).value === "true";
        if(isApp) {
            const checkedTypes = document.querySelectorAll(`input[name="v_type_${i}"]:checked`);
            if(checkedTypes.length === 0) { hasError = true; document.getElementById(`v_grid_${i}`).classList.add('error-border'); }
            const existVal = document.getElementById(`exist_${i}`).value.trim();
            if(existVal === "") { hasError = true; document.getElementById(`exist_${i}`).classList.add('error-border'); }
            const sc = document.getElementById(`res_${i}`).getAttribute('data-score');
            if(parseInt(sc) >= 3) {
                const newVal = document.getElementById(`new_${i}`).value.trim();
                if(newVal === "") { hasError = true; document.getElementById(`new_${i}`).classList.add('error-border'); }
            }
        }
    });
    if(hasError) { alert("è³‡æ–™æœªå¡«å¯«å®Œæ•´ï¼è«‹æª¢æŸ¥ç´…è‰²æ¨™ç¤ºè™•ã€‚"); return; }
    if(!hasSigned) { alert("è«‹å‹™å¿…åœ¨ä¸‹æ–¹ã€Œç°½åã€ç¢ºèªå¾Œæ‰èƒ½ä¸‹è¼‰ï¼"); return; }
    
    const dept = document.getElementById('empDept').value;
    const date = document.getElementById('evalDate').value;
    
    let rows = "";
    questions.forEach((q, i) => {
        const isApp = document.getElementById(`is_app_${i}`).value === "true";
        if (!isApp) {
             // ä¸é©ç”¨
             rows += `<tr style="background:#f9f9f9; color:#aaa;">
                <td style="text-align:center;">${q.id}</td>
                <td colspan="6" style="text-align:center;">${q.q} - (ä¸é©ç”¨)</td>
            </tr>`;
        } else {
            let checkedTypes = [];
            document.querySelectorAll(`input[name="v_type_${i}"]:checked`).forEach(cb => { checkedTypes.push(cb.value); });
            let typeStr = checkedTypes.join("ã€");
            const p = document.getElementById(`prob_${i}`).value;
            const s = document.getElementById(`sev_${i}`).value;
            const sc = document.getElementById(`res_${i}`).getAttribute('data-score');
            const exist = document.getElementById(`exist_${i}`).value;
            const newM = document.getElementById(`new_${i}`).value;
            
            let scoreVal = parseInt(sc);
            let riskHtml = "";
            let rowBg = "";
            
            if(scoreVal >= 6) { 
                riskHtml = `<span style="color:#c0392b;font-weight:bold;">${sc} (é«˜åº¦)</span>`; 
                rowBg = "background-color:#fff5f5;";
                highRiskCount++;
            }
            else if(scoreVal >= 3) { 
                riskHtml = `<span style="color:#e67e22;font-weight:bold;">${sc} (ä¸­åº¦)</span>`; 
                rowBg = "background-color:#fffbf0;";
                midRiskCount++;
            }
            else { 
                riskHtml = `<span style="color:#27ae60;font-weight:bold;">${sc} (ä½åº¦)</span>`; 
            }

            rows += `<tr style="${rowBg}">
                <td style="text-align:center;">${q.id}</td>
                <td><strong style="color:#000;">${q.q}</strong><br><span style='color:#666;font-size:0.85rem;'>[${typeStr}]</span></td>
                <td style="text-align:center;">${p}</td>
                <td style="text-align:center;">${s}</td>
                <td style="text-align:center;">${riskHtml}</td>
                <td>${exist}</td>
                <td>${scoreVal>=3 ? newM : '-'}</td>
            </tr>`;
        }
    });

    // çµ±ä¸€é¢¨æ ¼çš„ HTML å ±å‘Š
    const html = `<!DOCTYPE html><html><head><meta charset="UTF-8"><title>è©•ä¼°å ±å‘Š-${name}</title>
    <style>
        body{font-family:"Microsoft JhengHei", sans-serif; padding:20px; color:#333;}
        .header { text-align: center; border-bottom: 2px solid #0288d1; margin-bottom: 20px; padding-bottom: 10px; }
        .header h2 { margin: 0; color: #000; }
        .info-text { font-weight: bold; margin-bottom: 5px; color: #000; font-size: 1.1rem; }
        
        table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 0.95rem; }
        td, th { border: 1px solid #ccc; padding: 10px; vertical-align: top; }
        th { background: #f2f2f2; color: #333; font-weight: bold; }
        
        .footer-sig { margin-top: 40px; display: flex; gap: 60px; }
        .sig-box { text-align: left; }
        .sig-img { height: 60px; border-bottom: 1px solid #000; display: block; margin-top: 5px; }
        .sig-placeholder { height: 60px; width: 160px; border-bottom: 1px solid #000; color: #ccc; display: flex; align-items: end; margin-top: 5px; }
    </style></head><body>
    
    <div style="text-align:right;font-size:0.8rem;color:#888;">v7.1 (å ±å‘Šæ¨£å¼çµ±ä¸€ç‰ˆ)</div>
    
    <div class="header">
        <h2>è·å ´ä¸æ³•ä¾µå®³é é˜²è©•ä¼°å ±å‘Š</h2>
    </div>
    
    <div class="info-text">
        äººå“¡ï¼š${name} &nbsp;|&nbsp; éƒ¨é–€ï¼š${dept} &nbsp;|&nbsp; æ—¥æœŸï¼š${date}
    </div>
    
    <table>
      <thead>
        <tr>
          <th width="5%">ID</th>
          <th width="30%">è©•ä¼°é …ç›® (é¡å‹)</th>
          <th width="5%">P</th>
          <th width="5%">S</th>
          <th width="10%">é¢¨éšª</th>
          <th width="22%">ç¾æœ‰æ§åˆ¶</th>
          <th width="22%">æ–°å¢å°ç­–</th>
        </tr>
      </thead>
      <tbody>${rows}</tbody>
    </table>
    
    <p style="margin-top:15px; font-weight:bold;">
        çµæœçµ±è¨ˆï¼š
        ${highRiskCount > 0 ? '<span style="color:red">é«˜åº¦é¢¨éšª ('+highRiskCount+')</span>' : '<span style="color:#ccc">é«˜åº¦ (0)</span>'} ã€
        ${midRiskCount > 0 ? '<span style="color:orange">ä¸­åº¦é¢¨éšª ('+midRiskCount+')</span>' : '<span style="color:#ccc">ä¸­åº¦ (0)</span>'}
    </p>
    
    <div class="footer-sig">
        <div class="sig-box">
            <span>è©•ä¼°äººå“¡ç°½ç« ï¼š</span>
            <img src="${canvas.toDataURL()}" class="sig-img">
        </div>
        <div class="sig-box">
            <span>è·å®‰äººå“¡è¤‡æ ¸ï¼š</span>
            <div class="sig-placeholder">(è«‹ç°½æ ¸)</div>
        </div>
    </div>
    
    </body></html>`;
    
    const blob = new Blob([html], {type: "text/html"});
    const link = document.createElement("a");
    link.href = URL.createObjectURL(blob);
    link.download = `è·å ´ä¸æ³•ä¾µå®³é é˜²å ±å‘Š_${dept}_${name}_${date}.html`;
    link.click();
    alert("å ±å‘Šä¸‹è¼‰å®Œæˆï¼è«‹æ¥è‘—é»é¸ã€Œå¯„çµ¦è² è²¬äººã€ä¸¦é™„åŠ æª”æ¡ˆã€‚");
}

function sendEmail() {
    const name = document.getElementById('empName').value;
    const dept = document.getElementById('empDept').value;
    const subject = `è·å ´ä¸æ³•ä¾µå®³é é˜²ä¹‹å±å®³è¾¨è­˜åŠé¢¨éšªè©•ä¼°å ±å‘Š - ${dept} - ${name}`;
    const body = `è² è²¬äººæ‚¨å¥½ï¼Œ%0D%0A%0D%0Aé™„ä»¶ç‚ºæˆ‘çš„è·å ´ä¸æ³•ä¾µå®³è©•ä¼°å ±å‘Šï¼Œè«‹æŸ¥æ”¶ã€‚%0D%0A%0D%0Aè©•ä¼°äººå“¡ï¼š${name}`;
    window.location.href = `mailto:${managerEmail}?subject=${subject}&body=${body}`;
}
</script>
</body>
</html>



